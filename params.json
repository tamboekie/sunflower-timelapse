{
  "name": "Sunflower-timelapse",
  "tagline": "Use a Raspberry Pi and Camera Module to create a timelapse of a sunflower growing",
  "body": "# sunflower-timelapse\r\n\r\n## Introduction ##\r\nMy son planted a sunflower seed at school and had to bring it home to look after it and watch it grow. I thought it would be good to use timelapse-photography as a way to capture the slow progress and play it back later.\r\n\r\n## Quickstart ##\r\n1. Set up Raspberry Pi and Camera to take regular photos.\r\n2. Take the sequence of photos and turn them into a timelapse video.\r\n\r\n### Set up the camera ###\r\nI have a Raspberry Pi Camera board v1. The following script seems to yield decent results:\r\n```bash\r\n#!/bin/bash\r\nDATE=$(date +\"%Y%m%d_%H%M%S\")\r\n\r\nraspistill -q 97 -vf -hf -ex night -a 12 -o sun$DATE.jpg -v\r\nraspistill -q 97 -vf -hf -ex night -a 12 -o matrix_drc/sun${DATE}.jpg -v --awb flash --metering matrix --drc med\r\n```\r\n* The script will create pictures named using date and time. This makes it easy to work with the files if you are looking for an images taken at any one moment. However, to create a video the files will need to be renamed later.\r\n* ```-q 97```: JPEG quality is 97.\r\n* ```-vf -hf```: Flip both the vertical and horizontal axis. Depends on how you mount your sensor.\r\n* ```-ex night```: Use night exposure. This seems to work well for daylight too, but allows the camera to choose longer exposures when the light is low.\r\n* ```--awb flash```: I decided to avoid the auto white baolance setting to make sure I get a persistent white balance across. frames. I choose the flash white balance setting setting since it yielded the best result where I was taking pictures.\r\n* ```--metering matrix```: Not actually sure if this performs better than 'average', but this is what I used anyway.\r\n* ```--drc med```: The dynamic range setting of medium yielded some extra detail in darker areas of the image. \r\n\r\n\r\n### Copy the images to NAS ###\r\n```bash\r\nrsync -vvz -t -e ssh /home/pi/*.jpg fanus@sakkie.local:/media/data/fotos/sunflower/\r\n```\r\n* Will use SSH and will prompt for password\r\n* Add ```-n``` to do a dry-run and test the command\r\n\r\n\r\n### Cropping ###\r\nInput images are 2592x1944, but target frame is 1920x1080, andno resizing is needed. Only cropping.\r\n* Calculate X offset\r\n\t* Image width = 2592\r\n\t* Target width = 1920\r\n\t* X-offset = (2592 - 1920) / 2 = 336\r\n* Calculate Y offset\r\n  * Image height = 1944\r\n  * Target width = 1080\r\n  * Y offset = (1944 - 1080) / 2 = 432\r\n\r\nNow use ```convert``` [Imagemagick](http://www.imagemagick.org/script/convert.php) to crop the images\r\n```bash\r\nconvert \"$x\" -crop 1920x1080+336+432 \"$y\";\r\n```\r\n\r\n### White balance ###\r\nFound a really useful script written by [Fred Weinhaus](http://www.fmwconcepts.com/imagemagick/autowhite/index.php) called 'autowhite'. It managed to balance all images to an acceptable level without any further processing needed.\r\n```bash\r\nautowhite input.jpg output.png\r\n```\r\nI choose to output in PNG format to avoid further image qaulity loss.\r\n\r\n### Deflicker ###\r\nImages may hav different exposures, so you will need to 'deflicker' them, or adjust exposure and possibly white balance.\r\nTry this:\r\n* Original script: https://ubuntuforums.org/showthread.php?t=2022316\r\n* Another source for above https://github.com/rambo/timelapse/blob/master/timelapse-deflicker.pl\r\n\r\n* Different approach: http://im.snibgo.com/gainbias.htm\r\n\r\n\r\n```bash\r\nsudo apt-get install libfile-type-perl libterm-progressbar-perl\r\ngit clone https://github.com/cyberang3l/timelapse-deflicker/blob/master/timelapse-deflicker.pl\r\ncd timelapse-deflicker\r\n./timelapse-deflicker -h\r\n```\r\n\r\n\r\n### Rename Images ###\r\nRename a folder full of images (in this case they are named according to date and time) to a numbered list:\r\n```\r\nls sun20160808*.jpg| awk 'BEGIN{ a=0 }{ printf \"mv %s img%06d.JPG\\n\", $0, a++ }' | bash\r\n```\r\nOr, you could just symlink them:\r\n```\r\nls ~/matrix_drc/sun20160810*.jpg| awk 'BEGIN{ a=0 }{ printf \"ln -s %s img%06d.JPG\\n\", $0, a++ }' | bash\r\n```\r\nIf you wish to return to the original naming convention, these commands may help:\r\n```bash\r\nexiv2 rename -vtF -r \"sun%Y%m%d_%H%M%S\" *.JPG\r\nfind . -name '*.JPG' -exec rename 's/\\.JPG/\\.jpg/' '{}' \\;\r\n```\r\n\r\n\r\n---\r\n\r\n### Video ###\r\nEncode the numbered images to an MP4, 15fps, Q=22\r\n```\r\navconv -y -r 15 -i img%06d.JPG -r 15 -vcodec libx264 -crf 22.0 -vf crop=1920:1080,scale=iw:ih,unsharp,hqdn3d fullhd_unsharp2.mp4\u0001\r\n```\r\n* Will crop the input images to 1080p. Not sure what will happen if inout is smaller.\r\n* I find the unsharp filter helps with the soft images out of the RPi camera v1\r\n* The hqdn3 filter reduces some noise, which in turn reduces file size,  but still preserves edges.\r\n\r\n\r\n---\r\n### References ###\r\nClick [here](http://techedemic.com/2014/09/18/creating-a-timelapse-clip-with-avconv/) for the orignal post.\r\nGeneral timelapse info at [www.learntimelapse.com](http://www.learntimelapse.com/time-lapse-exposure-avoiding-flicker-and-dragging-shutter/)\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}