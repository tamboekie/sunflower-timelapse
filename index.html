<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Sunflower-timelapse by tamboekie</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Sunflower-timelapse</h1>
        <p class="header">Use a Raspberry Pi and Camera Module to create a timelapse of a sunflower growing</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/tamboekie/sunflower-timelapse/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/tamboekie/sunflower-timelapse/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/tamboekie/sunflower-timelapse">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/tamboekie">tamboekie</a></p>


      </header>
      <section>
        <h1>
<a id="sunflower-timelapse" class="anchor" href="#sunflower-timelapse" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>sunflower-timelapse</h1>

<p><img src="https://tamboekie.github.io/sunflower-timelapse/images/head.jpg" alt="heading"></p>

<h2>
<a id="background" class="anchor" href="#background" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Background</h2>

<p>My son planted a sunflower seed at school and had to bring it home to look after it and watch it grow. I thought it would be good to use time-lapse photography as a way to capture the slow progress and play it back later. Below, I tried to document the various commands I used to make this happen. I will admit that none of this is perfect, but it is offered in the hope that someone may benefit from it. The assumption is that you have a basic understanding of the Linux terminal, but you may have not played with time-lapse photography before.</p>

<h2>
<a id="hardware" class="anchor" href="#hardware" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Hardware</h2>

<p>I used a Raspberry Pi, a Camera Module and other miscellaneous bits to build the photography rig. The sunflower was placed in conservatory, as it offered good light. I did not want to try do this outdoors since that would involve weather-proofing the Pi and camera. Here's a short list of items I used:</p>

<ul>
<li>
<a href="https://www.raspberrypi.org/learning/hardware-guide/components/raspberry-pi/">Raspberry Pi 3</a> with a small heatsink. Any model B Raspbery Pi will work for this project.</li>
<li>Raspberry Pi <a href="https://www.raspberrypi.org/products/camera-module/">Camera Module V1</a>.</li>
<li>An official <a href="http://cpc.farnell.com/stontronics/t5875dv/psu-raspberry-pi-5v-2-5a-multi/dp/SC14025">2.5A power supply</a>.</li>
<li>A very rough wooden frame to position the camera where I wanted it.</li>
<li>A home-made camera mount, angled to point at the sunflower, of course.</li>
</ul>

<p>The actual build of the frame and mount is not that important - I did the minimum to make sure it was fixed properly. I will add that a sturdy camera mount is very important. The camera module is nearly impossible to position without a mount - don't use a hot glue gun or Blu-Tack. I made my mount from small squire plastic bottle, cut down to the right size and then screwed into the wooden frame I made.
<img src="https://tamboekie.github.io/sunflower-timelapse/images/P1140737_crop.JPG" alt="camera mount complete"></p>

<h2>
<a id="software-setup" class="anchor" href="#software-setup" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Software setup</h2>

<h3>
<a id="raspberry-pi-installation" class="anchor" href="#raspberry-pi-installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Raspberry Pi installation</h3>

<p>You will need to do some basic setup on the Raspberry Pi. It may be possible to do everything on the Pi, but I choose to most of the post-processing on my desktop machine</p>

<ul>
<li>
<a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian</a> Jesse - this is the recommended OS so you probably have this already. Both the Lite and the Desktop variants will work fine.</li>
<li>You will need to enable the Camera Module using <code>raspi-config</code> - read more <a href="https://www.raspberrypi.org/documentation/configuration/camera.md">here</a>
</li>
</ul>

<h3>
<a id="client-desktop-installation" class="anchor" href="#client-desktop-installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Client (desktop) installation</h3>

<p>I use Ubuntu Linux as my desktop OS. I needed the following packages</p>

<ul>
<li>ffmpeg</li>
<li>imagemagick (convert command)</li>
<li>
<code>timelapse-deflicker</code> - follow instrcutions from <a href="https://github.com/cyberang3l/timelapse-deflicker">cyberang3l's github</a>.</li>
</ul>

<p>Run the commands below to install the dependancies:</p>

<div class="highlight highlight-source-shell"><pre>sudo apt-get update
sudo apt-get install ffmpeg imagemagick</pre></div>

<h2>
<a id="capture-the-photos" class="anchor" href="#capture-the-photos" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Capture the photos</h2>

<p>The command-line utlity to capture still images with the Raspberry Pi is called <a href="https://www.raspberrypi.org/documentation/raspbian/applications/camera.md">raspistill</a>. It can be used to grab images from the camera module and allows a full-control of the sensor. While it has a built-in time-lapse mode, I found that this was not very stable over long periods. I used cron to schedule the capture instead.</p>

<p>A simple script is useful to hold all the settings for <code>raspistill</code>. This is better than adding all the settings directly to your cron job. I left most things at the default:</p>

<div class="highlight highlight-source-shell"><pre><span class="pl-c">#!/bin/bash</span>
DATE=<span class="pl-s"><span class="pl-pds">$(</span>date +<span class="pl-s"><span class="pl-pds">"</span>%Y%m%d_%H%M%S<span class="pl-pds">"</span></span><span class="pl-pds">)</span></span>

raspistill -q 97 -vf -hf -ex night -a 12 -o sun<span class="pl-smi">$DATE</span>.jpg -v</pre></div>

<ul>
<li>The script will create pictures with the date and time added to the filename. This makes it easy to work with the files if you are looking for an image taken at any one moment. However, to create a video the files will need to be renamed later.</li>
<li>
<code>-q 97</code>: JPEG quality is 97.</li>
<li>
<code>-vf -hf</code>: Flip both the vertical and horizontal axis. Depends on how you mount your sensor.</li>
<li>
<code>-ex night</code>: Use night exposure. This seems to work well for daylight too, but allows the camera to choose longer exposures when the light is low.</li>
<li>
<code>-a 12</code>: This adds the date and time directly to the picture. Remove if not needed.</li>
<li>
<code>-v</code>: Turn on verbose output. You can choose to omit this if not needed.</li>
</ul>

<p>You can add a cron job like this:</p>

<div class="highlight highlight-source-shell"><pre>crontab -e</pre></div>

<p>Then, just add this line</p>

<pre lang="cron"><code>*/2    5-20     *       *       *       $HOME/sunflowercam.sh
</code></pre>

<ul>
<li>
<code>*/2</code>: Will take an image every <strong>2</strong> minutes. The fastest you can do this is 1 minute</li>
<li>
<code>5-20</code>: Images will be taken from 5am to just before 9pm - in the South-East of England, usually light during this range in the summer months. Experiment with what is right for you.</li>
<li>
<code>* * *</code>: The images are captured every single day without exception. Rememnber to remove the cron job at the end of the project!</li>
<li>Also remember that each image takes up to 3Mb of disk space - make sure you have enough space</li>
</ul>

<h3>
<a id="copy-the-images-to-nas" class="anchor" href="#copy-the-images-to-nas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Copy the images to NAS</h3>

<p>As I choose to process the images on my desktop, I needed an easy way to copy images across from the Pi. I initially used sftp, but eventually found rsync faster:</p>

<div class="highlight highlight-source-shell"><pre>rsync -vvz -t -e ssh /home/pi/<span class="pl-k">*</span>.jpg user@hostname.<span class="pl-k">local</span>:/media/data/sunflower/</pre></div>

<ul>
<li>Substitute your own <code>user</code> and <code>hostname</code> in the above command.</li>
<li>Will use SSH and will prompt for password.</li>
<li>Add <code>-n</code> to do a dry-run and test the command without doing any copying.<br>
</li>
</ul>

<p><strong>Note</strong>: As I said above, make sure you have enough space and regularly remove old images from the Pi once you have them copied to a safe place.</p>

<h3>
<a id="cropping" class="anchor" href="#cropping" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Cropping</h3>

<p>The camera module has a fixed focus and without a lens it needs to be more than 1 meter away from the subject. I placed my camera as close as practical and then captured the images at full resolution with the intention to crop/resize later. Some experimentation is needed here to ensure good focus. The final aim is to make a video of all the images and I wanted to work at full HD, or 1920x1080.</p>

<p>Input images are 2592x1944 on the v1 camera module, but my target frame size is 1920x1080, and no I found that no resizing was needed. Only cropping.</p>

<ul>
<li>Calculate X offset

<ul>
<li>Image width = 2592</li>
<li>Target width = 1920</li>
<li>X-offset = (2592 - 1920) / 2 = 336</li>
</ul>
</li>
<li>Calculate Y offset

<ul>
<li>Image height = 1944</li>
<li>Target width = 1080</li>
<li>Y offset = (1944 - 1080) / 2 = 432</li>
</ul>
</li>
</ul>

<p>Now use <code>convert</code> <a href="http://www.imagemagick.org/script/convert.php">Imagemagick</a> to crop the images</p>

<div class="highlight highlight-source-shell"><pre>convert input.jpg -crop 1920x1080+336+432 output.png</pre></div>

<ul>
<li>I convert the JPEG input image to a PNG to avoid the loss of quality</li>
</ul>

<h3>
<a id="white-balance" class="anchor" href="#white-balance" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>White balance</h3>

<p>There is a really useful script written by <a href="http://www.fmwconcepts.com/imagemagick/autowhite/index.php">Fred Weinhaus</a> called <code>autowhite</code>. It managed to balance all images to an acceptable level without any further processing needed.</p>

<div class="highlight highlight-source-shell"><pre>autowhite input.jpg output.png</pre></div>

<p>I choose to output in PNG format to avoid further image qaulity loss.</p>

<h3>
<a id="deflicker" class="anchor" href="#deflicker" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Deflicker</h3>

<p>Images may have different exposures, so you will need to 'deflicker' them, or adjust exposure and possibly white balance.
Try this:</p>

<ul>
<li>Original script: <a href="https://ubuntuforums.org/showthread.php?t=2022316">https://ubuntuforums.org/showthread.php?t=2022316</a>
</li>
<li>Another source for above <a href="https://github.com/rambo/timelapse/blob/master/timelapse-deflicker.pl">https://github.com/rambo/timelapse/blob/master/timelapse-deflicker.pl</a>
</li>
<li>Different approach: <a href="http://im.snibgo.com/gainbias.htm">http://im.snibgo.com/gainbias.htm</a>
</li>
</ul>

<div class="highlight highlight-source-shell"><pre>sudo apt-get install libfile-type-perl libterm-progressbar-perl
git clone https://github.com/cyberang3l/timelapse-deflicker/blob/master/timelapse-deflicker.pl
<span class="pl-c1">cd</span> timelapse-deflicker
./timelapse-deflicker -h</pre></div>

<h3>
<a id="rename-images" class="anchor" href="#rename-images" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Rename Images</h3>

<p>Rename a folder full of images (in this case they are named according to date and time) to a numbered list:</p>

<div class="highlight highlight-source-shell"><pre>ls sun20160808<span class="pl-k">*</span>.jpg<span class="pl-k">|</span> awk <span class="pl-s"><span class="pl-pds">'</span>BEGIN{ a=0 }{ printf "mv %s img%06d.JPG\n", $0, a++ }<span class="pl-pds">'</span></span> <span class="pl-k">|</span> bash</pre></div>

<p>Or, you could just symlink them:</p>

<div class="highlight highlight-source-shell"><pre>ls <span class="pl-k">~</span>/matrix_drc/sun20160810<span class="pl-k">*</span>.jpg<span class="pl-k">|</span> awk <span class="pl-s"><span class="pl-pds">'</span>BEGIN{ a=0 }{ printf "ln -s %s img%06d.JPG\n", $0, a++ }<span class="pl-pds">'</span></span> <span class="pl-k">|</span> bash</pre></div>

<p>If you wish to return to the original naming convention, these commands may help:</p>

<div class="highlight highlight-source-shell"><pre>exiv2 rename -vtF -r <span class="pl-s"><span class="pl-pds">"</span>sun%Y%m%d_%H%M%S<span class="pl-pds">"</span></span> <span class="pl-k">*</span>.JPG
find <span class="pl-c1">.</span> -name <span class="pl-s"><span class="pl-pds">'</span>*.JPG<span class="pl-pds">'</span></span> -exec rename <span class="pl-s"><span class="pl-pds">'</span>s/\.JPG/\.jpg/<span class="pl-pds">'</span></span> <span class="pl-s"><span class="pl-pds">'</span>{}<span class="pl-pds">'</span></span> <span class="pl-cce">\;</span></pre></div>

<hr>

<h3>
<a id="video" class="anchor" href="#video" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Video</h3>

<p>Encode the numbered images to an MP4, 15fps, Q=22</p>

<div class="highlight highlight-source-shell"><pre>avconv -y -r 15 -i img%06d.JPG -r 15 -vcodec libx264 -crf 22.0 -vf crop=1920:1080,scale=iw:ih,unsharp,hqdn3d fullhd_unsharp2.mp4</pre></div>

<ul>
<li>Will crop the input images to 1080p. Not sure what will happen if inout is smaller.</li>
<li>I find the unsharp filter helps with the soft images out of the RPi camera v1</li>
<li>The hqdn3 filter reduces some noise, which in turn reduces file size,  but still preserves edges.</li>
</ul>

<hr>

<h3>
<a id="references" class="anchor" href="#references" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>References</h3>

<p>Click <a href="http://techedemic.com/2014/09/18/creating-a-timelapse-clip-with-avconv/">here</a> for the orignal post.
General timelapse info at <a href="http://www.learntimelapse.com/time-lapse-exposure-avoiding-flicker-and-dragging-shutter/">www.learntimelapse.com</a></p>

<h2>
<a id="final-thoughts" class="anchor" href="#final-thoughts" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Final thoughts</h2>

<ul>
<li>If you have a choice, get the <a href="https://www.raspberrypi.org/products/camera-module-v2/">V2 camera module</a>. It uses a much better (Sony) image sensor, which should result in a higher quality photos.</li>
</ul>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
